apiVersion: v1
kind: ConfigMap
metadata:
  name: trilog-clickhouse-config
  namespace: trilog-system
  labels:
    app: trilog-clickhouse
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/component: storage
    app.kubernetes.io/part-of: trilog
data:
  init.sql: |
    -- TriLog ClickHouse Initialization Script
    -- This script creates the database and tables for TriLog storage.

    -- Create database
    CREATE DATABASE IF NOT EXISTS trilog;

    -- Switch to trilog database
    USE trilog;

    -- ============================================================================
    -- MAIN EVENTS TABLE
    -- Stores all TriLog events with full attributes
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS trilog_events
    (
        -- Core identifiers
        timestamp DateTime64(9) DEFAULT now64(9),
        obj_id String,
        obj_type LowCardinality(String),
        event_type LowCardinality(String) DEFAULT 'state_change',

        -- OpenTelemetry context
        trace_id String DEFAULT '',
        span_id String DEFAULT '',
        parent_span_id String DEFAULT '',

        -- Event payload (as JSON string for flexibility)
        attributes String DEFAULT '{}',

        -- Additional metadata
        severity_text LowCardinality(String) DEFAULT 'INFO',
        service_name LowCardinality(String) DEFAULT '',
        service_version String DEFAULT '',

        -- Indexing helpers
        _partition Date DEFAULT toDate(timestamp),
        _inserted_at DateTime64(3) DEFAULT now64(3)
    )
    ENGINE = MergeTree()
    PARTITION BY toYYYYMM(_partition)
    ORDER BY (obj_type, obj_id, timestamp)
    TTL _partition + INTERVAL 90 DAY DELETE
    SETTINGS
        index_granularity = 8192,
        ttl_only_drop_parts = 1;

    -- Create index for trace correlation
    ALTER TABLE trilog_events
        ADD INDEX IF NOT EXISTS idx_trace_id trace_id TYPE bloom_filter GRANULARITY 4;

    -- ============================================================================
    -- SNAPSHOTS TABLE
    -- Stores periodic snapshots of object state for faster reconstruction
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS trilog_snapshots
    (
        snapshot_id String,
        obj_id String,
        obj_type LowCardinality(String),
        timestamp DateTime64(9),
        state String,  -- JSON serialized state
        version UInt64,
        _created_at DateTime64(3) DEFAULT now64(3)
    )
    ENGINE = ReplacingMergeTree(_created_at)
    ORDER BY (obj_id, timestamp)
    TTL _created_at + INTERVAL 180 DAY DELETE;

    -- ============================================================================
    -- PROCESSES TABLE
    -- Stores high-level process/workflow information
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS trilog_processes
    (
        process_id String,
        process_type LowCardinality(String),
        trace_id String,
        started_at DateTime64(9),
        completed_at Nullable(DateTime64(9)),
        status LowCardinality(String),
        metadata String DEFAULT '{}'
    )
    ENGINE = ReplacingMergeTree(completed_at)
    ORDER BY (process_type, process_id, started_at);

    -- ============================================================================
    -- MIGRATIONS TABLE
    -- Tracks schema migrations
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS trilog_migrations
    (
        version String,
        applied_at DateTime64(3) DEFAULT now64(3),
        description String
    )
    ENGINE = MergeTree()
    ORDER BY applied_at;

    -- Insert initial migration marker
    INSERT INTO trilog_migrations (version, description)
    VALUES ('1.0.0', 'Initial TriLog schema')
    ON CONFLICT DO NOTHING;
